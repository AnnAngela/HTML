<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.13.1 (455785)"/><meta name="author" content="moonbeammm丶"/><meta name="created" content="2018-01-22 06:19:44 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2018-01-22 13:22:59 +0000"/><title>1-1-卡片动态化XIB方案</title></head><body><div>Update: 2018-1.22</div><div>Version: 1.0</div><div><br/></div><div><br/></div><div><span style="font-size: 23px;">一.场景</span></div><div><br/></div><div>对于客户端来说.版本发出以后.代码就不能修改了.但是因为首页卡片的样式还处于试验阶段.</div><div>所以每期都有要修改卡片样式或者增加卡片类型的需求.</div><div>并且每次修改都必须严格跟着版本走.</div><div>对于开发和产品的都是不小的人力.</div><div><br/></div><div>因为首页是一张张卡片拼凑而成.</div><div>所以我们可以以一张卡片为一个单位.</div><div>然后用xib生成一张张类型不同的卡片.</div><div>客户端从服务端动态拉取这些卡片.</div><div>然后渲染在客户端页面上.</div><div>这样就可以实现卡片样式由服务端来控制.</div><div>大大减少了开发的人力成本.</div><div><br/></div><div><br/></div><div><font style="font-size: 22px;">二.XIB方案总体框架</font></div><div><br/></div><div><font style="font-size: 17px;">2.1.tableview代理方法实现</font></div><div><br/></div><div>创建tableviewVC.实现numberOfRowsInsection和cellForRowAtIndexPath方法.</div><div><br/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/19CFB7FC-9F4A-48FF-B49D-8925C28771D9.png" height="388" width="960"/><br/></div><div><br/></div><div>不需要实现heightForRowAtIndexPath方法.给tableView的rowHeight方法设置为自动计算.</div><div>这样cell的高度会由子控件来控制.</div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/457AC340-A948-43B9-A7E9-0A2F0FB766E4.png" height="19" width="434"/></div><div><br/></div><div><font style="font-size: 18px;">2.2.cell注册</font></div><div><br/></div><div>注册的cell类型由服务端下发的json控制.</div><div><br/></div><div><font style="font-size: 18px;">2.3.获取cell</font></div><div><br/></div><div>因为xib为动态下发并且保存在本地沙盒.</div><div>所以会先去取服务端下发的xib.</div><div>如果没有.本地会有一份容错xib作为容错.</div><div><br/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/FB3BD304-77E1-4A44-8473-9EC7BCD1EBD1.png" height="226" width="738"/></div><div><br/></div><div><span style="font-size: 22px;">三.XIB方案具体实现</span></div><div><br/></div><div><font style="font-size: 18px;">3.1.动态布局</font></div><div><br/></div><div>因为xib是动态下发的.所以动态布局这一问题自然而然就解决了.完全通过苹果原生的Autolayout解决.</div><div><br/></div><div><font style="font-size: 18px;">3.2.数据绑定</font></div><div><br/></div><div>如图我们可以给每个控件的数据设置value.</div><div>比如这个控件是coverImageView.他需要的数据对应的是服务端的cover字段.</div><div>那么我们在这里就可以设置bili_content属性的value为cover.</div><div><br/></div><div>当数据请求成功后会在加载cell的时候遍历所有子控件.</div><div>并把bili_content对应的值赋给该控件.</div><div><br/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/618F420A-3BD2-4ED5-ABD2-01DB272EA233.png" height="315" width="383"/><br/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/BB5D4C4B-9791-4953-B539-B97D626E99B1.png" height="340" width="719"/></div><div><br/></div><div><font style="font-size: 18px;">3.3.事件绑定</font></div><div><br/></div><div>在awakeFromNib方法里会遍历每个控件.</div><div>查看是否设置了bili_event.</div><div>如果有就绑定对应的事件.</div><div>并把事件处理抛给VC操作.</div><div><br/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/0E4D4E20-E244-40E0-93E8-AF8D6853E7D1.png" height="93" width="383"/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/EEFA32A4-51F2-4ED4-A0C4-DE9626F8A18B.png" height="577" width="788"/></div><div><br/></div><div><font style="font-size: 18px;">3.4.支持多主题</font></div><div><br/></div><div>每个控件都会注册多主题事件.</div><div>具体是什么颜色由bili_titleColor 或 bili_bgColor 或 bili_alpha控制.</div><div><br/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/785BD30F-DFA4-4447-BD42-D278732B9646.png" height="113" width="380"/></div><div><br/></div><div><img src="1-1-%E5%8D%A1%E7%89%87%E5%8A%A8%E6%80%81%E5%8C%96XIB%E6%96%B9%E6%A1%88.resources/2C595112-37D8-4356-9C86-A8B467D1B1C3.png" height="248" width="733"/></div><div><br/></div><div><span style="font-size: 22px;">三.服务端控制版本方案</span></div><div><br/></div><div><font style="font-size: 17px;">3.1.客户端冷启动拉取xib</font></div><div><br/></div><div>在客户端冷启动的时候.在didFinishLaunch方法里请求接口.</div><div>并将数据保存到沙盒中.</div><div><br/></div><div>服务端需要下发所有类型卡片的.nib文件.和一份所有类型的json.</div><div><br/></div><div>为了以后能不需要通过发版就增加和减少卡片类型.</div><div><br/></div><div>服务端最好能把.nib的命名格式为如下:</div><div><br/></div><div>&lt;bili&gt;+&lt;type&gt;+&lt;版本&gt;.nib</div><div><br/></div><div>在客户端会默认以该名称为cell的注册标识符.</div><div><br/></div><div><font style="font-size: 17px;">3.2.版本兼容</font></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-size: 23px;">四.局限性</span></div><div><br/></div><div>因为该方案是下发xib.xib只能修改布局和数据绑定.</div><div>但是不能动态修改逻辑.</div><div>所以不能支持动态添加特殊的事件.</div><div>比如点击某处可以弹出某个弹窗.</div><div><br/></div><div>只能动态支持给某个控件添加点击后通过uri跳转的事件.</div><div><br/></div><div><br/></div><div><br/></div></body></html>